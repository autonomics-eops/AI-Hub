<fragment>
    <!-- Log OpenAI usage to EventHub -->
    <choose>
        <when condition="@(context.Response.StatusCode == 200)">
            <log-to-eventhub logger-id="usage-eh-logger">@{
                return new JObject(
                    new JProperty(&quot;id&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;idPrefix&quot;, &quot;ai&quot;) + &quot;-&quot; + Guid.NewGuid().ToString()),
                    new JProperty(&quot;timestamp&quot;, DateTime.UtcNow.ToString()),
                    new JProperty(&quot;appId&quot;, context.Request.Headers.GetValueOrDefault(&quot;Authorization&quot;, string.Empty).Split(' ').LastOrDefault()?.AsJwt()?.Claims.GetValueOrDefault(&quot;appid&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;subscriptionId&quot;, context.Subscription?.Id?.ToString() ?? &quot;Portal-Admin&quot;),
                    new JProperty(&quot;productName&quot;, context.Product?.Name?.ToString() ?? &quot;Portal-Admin&quot;),
                    new JProperty(&quot;targetService&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;targetService&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;model&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;model&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;gatewayName&quot;, context.Deployment?.ServiceName ?? &quot;NA&quot;),
                    new JProperty(&quot;gatewayRegion&quot;, context.Deployment?.Region ?? &quot;NA&quot;),
                    new JProperty(&quot;aiGatewayId&quot;, context.Deployment?.Gateway?.Id ?? &quot;NA&quot;),
                    new JProperty(&quot;RequestIp&quot;, context.Request?.IpAddress ?? &quot;NA&quot;),
                    new JProperty(&quot;operationName&quot;, context.Operation?.Name ?? &quot;NA&quot;),
                    new JProperty(&quot;sessionId&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;sessionId&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;endUserId&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;endUserId&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;backendId&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;backendId&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;routeLocation&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;routeLocation&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;routeName&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;routeName&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;deploymentName&quot;, (string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;deploymentName&quot;, &quot;NA&quot;)),
                    new JProperty(&quot;promptTokens&quot;, (int)context.Variables.GetValueOrDefault&lt;int&gt;(&quot;promptTokens&quot;, 1)),
                    new JProperty(&quot;responseTokens&quot;, (int)context.Variables.GetValueOrDefault&lt;int&gt;(&quot;responseTokens&quot;, 0)),
                    new JProperty(&quot;totalTokens&quot;, (int)context.Variables.GetValueOrDefault&lt;int&gt;(&quot;totalTokens&quot;, 1))
                ).ToString();
            }</log-to-eventhub>
        </when>
    </choose>
</fragment>
