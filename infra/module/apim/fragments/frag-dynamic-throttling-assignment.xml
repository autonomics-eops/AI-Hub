<fragment>
    <set-variable name="assignedRouteIndex" value="@{
        JArray routes = (JArray)context.Variables[&quot;routes&quot;];
        int selectedPriority = Int32.MaxValue;
        List&lt;int&gt; availableRoutesIndexes = new List&lt;int&gt;();

        for (int i = 0; i &lt; routes.Count; i++)
        {
            JObject route = (JObject)routes[i];

            if (!route.Value&lt;bool&gt;(&quot;isThrottling&quot;))
            {
                int routePriority = route.Value&lt;int&gt;(&quot;priority&quot;);

                if (routePriority &lt; selectedPriority)
                {
                    selectedPriority = routePriority;
                    availableRoutesIndexes.Clear();
                    availableRoutesIndexes.Add(i);
                }
                else if (routePriority == selectedPriority)
                {
                    availableRoutesIndexes.Add(i);
                }
            }
        }

        if (availableRoutesIndexes.Count == 1)
        {
            return availableRoutesIndexes[0];
        }

        if (availableRoutesIndexes.Count &gt; 0)
        {
            return availableRoutesIndexes[new Random().Next(0, availableRoutesIndexes.Count)];
        }

        return 0;
    }" />
</fragment>
