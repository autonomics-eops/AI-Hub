<fragment>
    <set-variable name="routesCacheKey" value="@((string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;routesCacheKey&quot;, &quot;ALL-ROUTES&quot;))" />
    <cache-lookup-value key="@((string)context.Variables[&quot;routesCacheKey&quot;])" variable-name="routes" />
    <choose><when condition="@(context.Variables.ContainsKey(&quot;routes&quot;) == false)">
        <set-variable name="routes" value="@{ string deploymentName = (string)context.Variables[&quot;deployment-id&quot;]; JArray clusters = (JArray)context.Variables[&quot;oaClusters&quot;]; JObject cluster = (JObject)clusters.FirstOrDefault(o =&gt; o[&quot;deploymentName&quot;]?.Value&lt;string&gt;() == deploymentName); if(cluster == null) { return new JArray() { new JObject() { { &quot;name&quot;, deploymentName }, { &quot;location&quot;, &quot;NA&quot; }, { &quot;url&quot;, &quot;No routes found for the deployment (&quot; + deploymentName + &quot;) in the region (&quot; + context.Deployment.Region + &quot;)&quot; }} };} JArray routes = (JArray)cluster[&quot;routes&quot;]; return routes;}" />
        <choose><when condition="@(((JArray)context.Variables[&quot;routes&quot;]).ToString().Contains(&quot;No routes&quot;))">
            <return-response>
                <set-status code="400" reason="No routes" />
                <set-body>@(((JArray)context.Variables[&quot;routes&quot;]).ToString())</set-body>
            </return-response>
        </when></choose>
        <cache-store-value key="@((string)context.Variables[&quot;routesCacheKey&quot;])" value="@((JArray)context.Variables[&quot;routes&quot;])" duration="86400" />
    </when></choose>
    <set-variable name="routeIndex" value="-1" />
    <set-variable name="remainingRoutes" value="1" />
</fragment>
