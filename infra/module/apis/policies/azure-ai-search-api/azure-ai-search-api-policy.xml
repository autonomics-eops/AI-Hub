<policies>
    <inbound>
        <base />
        <!-- AAD Authorization -->
        <!-- Enabled if entra-validate named value is set to true -->
        <include-fragment fragment-id="frag-aad-auth" />
        <set-header name="api-key" exists-action="delete" />
        <!-- Setting cache keys -->
        <set-variable name="deployment-id" value="@((string)context.Request.MatchedParameters[&quot;index-name&quot;])" />
        <set-variable name="routesCacheKey" value="@((string)context.Variables[&quot;deployment-id&quot;] + &quot;Routes&quot; + context.Deployment.Region + context.Api.Revision)" />
        <set-variable name="oaClustersCacheKey" value="@(&quot;aiSearchInstance&quot; + context.Deployment.Region + context.Api.Revision)" />
        <cache-lookup-value key="@((string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;oaClustersCacheKey&quot;, &quot;ALL-SEARCH&quot;))" variable-name="oaClusters" />
        <!-- If we can't find the configuration cached, it will be loaded -->
        <choose>
            <when condition="@(context.Variables.ContainsKey(&quot;oaClusters&quot;) == false)">
                <set-variable name="oaClusters" value="@{
                        // route is an Azure AI Search endpoint
                        JArray routes = new JArray();
                        // cluster is a group of routes that are capable of serving a specific index name
                        JArray clusters = new JArray();
                        // Update the below if condition when using multiple APIM gateway regions/SHGW to get different configurations for each region
                        if(context.Deployment.Region == &quot;West Europe&quot; || true)
                        {
                            // Adding all Azure AI Search endpoints routes (which are set as APIM Backend)
                            routes.Add(new JObject()
                            {
                                { &quot;name&quot;, &quot;AISearch001&quot; },
                                { &quot;location&quot;, &quot;Sweden Central&quot; },
                                { &quot;backend-id&quot;, &quot;backend-search-001&quot; },
                                { &quot;priority&quot;, 1},
                                { &quot;isThrottling&quot;, false }, 
                                { &quot;retryAfter&quot;, DateTime.MinValue } 
                            });

                            // For each index, create a cluster with the routes that can serve it
                            clusters.Add(new JObject()
                            {
                                { &quot;deploymentName&quot;, &quot;gptkbindex&quot; },
                                { &quot;routes&quot;, new JArray(routes[0]) }
                            });
                        }
                        else
                        {
                            //No clusters found for selected region, either return error (default behavior) or set default cluster in the else section
                        }
                        
                        return clusters;   
                    }" />
                <!-- Add cluster configurations to cache -->
                <cache-store-value key="@((string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;oaClustersCacheKey&quot;, &quot;ALL-SEARCH&quot;))" value="@((JArray)context.Variables[&quot;oaClusters&quot;])" duration="86400" />
            </when>
        </choose>
        <include-fragment fragment-id="frag-validate-routes" />
        <authentication-managed-identity resource="https://search.azure.com" output-token-variable-name="msi-access-token" client-id="{{uami-client-id}}" ignore-error="false" />
        <set-header name="Authorization" exists-action="override">
            <value>@(&quot;Bearer &quot; + (string)context.Variables[&quot;msi-access-token&quot;])</value>
        </set-header>
    </inbound>
    <backend>
        <include-fragment fragment-id="frag-backend-routing" />
    </backend>
    <outbound>
        <base />
        <set-variable name="idPrefix" value="search" />
        <set-variable name="targetService" value="AI-Search" />
        <set-variable name="model" value="@((string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;deployment-id&quot;, &quot;AI-SEARCH-INDEX&quot;))" />
        <set-variable name="deploymentName" value="@((string)context.Variables.GetValueOrDefault&lt;string&gt;(&quot;deployment-id&quot;, &quot;AI-SEARCH-SERVICE&quot;))" />
        <include-fragment fragment-id="frag-ai-usage" />
    </outbound>
    <on-error>
        <base />
        <set-variable name="service-name" value="Azure AI Search" />
        <set-variable name="target-deployment" value="@((string)context.Request.MatchedParameters[&quot;index-name&quot;])" />
        <include-fragment fragment-id="frag-throttling-events" />
    </on-error>
</policies>
